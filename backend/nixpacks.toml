# Railway Nixpacks configuration for Saleor installation
# Saleor must be installed from GitHub, not PyPI
# Using virtual environment to avoid Nix externally-managed-environment restrictions

[phases.setup]
nixPkgs = ["python312", "git", "file"]  # 'file' package provides libmagic for python-magic

[phases.install]
cmds = [
  "python3 -m venv .venv",
  "source .venv/bin/activate && pip install --upgrade pip setuptools wheel",
  # Install Saleor FIRST to get its dependency versions
  "source .venv/bin/activate && pip install git+https://github.com/saleor/saleor.git",
  # Then install our additional requirements (will use compatible versions)
  "source .venv/bin/activate && pip install -r requirements.txt",
  "source .venv/bin/activate && python -c 'import saleor; print(f\"Saleor installed: {saleor.__version__}\")' || echo 'WARNING: Saleor import check failed'",
]

[phases.build]
cmds = [
  ". .venv/bin/activate && python manage.py collectstatic --noinput || true",
  # Set up libmagic path before running migrations (required for Saleor imports)
  # Note: makemigrations may fail if DATABASE_URL is not set, which is OK - migrations will be created on startup
  "LIB_PATH=$(find /nix/store -name libmagic.so* 2>/dev/null | head -1 | xargs dirname 2>/dev/null); export LD_LIBRARY_PATH=$LD_LIBRARY_PATH${LIB_PATH:+:$LIB_PATH}; . .venv/bin/activate && python manage.py makemigrations regions currency branches inventory --noinput 2>&1 || echo '⚠️  Migrations creation skipped (will retry on startup if needed)'",
  # Run all migrations (Saleor + custom apps)
  # Note: This requires DATABASE_URL to be set during build
  # If DATABASE_URL is not available, migrations will run on startup instead
  "LIB_PATH=$(find /nix/store -name libmagic.so* 2>/dev/null | head -1 | xargs dirname 2>/dev/null); export LD_LIBRARY_PATH=$LD_LIBRARY_PATH${LIB_PATH:+:$LIB_PATH}; . .venv/bin/activate && python manage.py migrate --noinput 2>&1 || echo '⚠️  Migration skipped during build (will retry on startup)'",
]

[start]
cmd = "bash -c 'LIB_PATH=$(find /nix/store -name libmagic.so* 2>/dev/null | head -1 | xargs dirname 2>/dev/null); export LD_LIBRARY_PATH=$LD_LIBRARY_PATH${LIB_PATH:+:$LIB_PATH} && export PYTHONPATH=$PYTHONPATH && source .venv/bin/activate && gunicorn wsgi:application --bind 0.0.0.0:$PORT --workers 4 --timeout 120'"
