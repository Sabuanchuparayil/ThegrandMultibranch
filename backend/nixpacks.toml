# Railway Nixpacks configuration for Saleor installation
# Saleor must be installed from GitHub, not PyPI
# Using virtual environment to avoid Nix externally-managed-environment restrictions

[phases.setup]
nixPkgs = ["python312", "git", "file"]  # 'file' package provides libmagic for python-magic

[phases.install]
cmds = [
  "python3 -m venv .venv",
  "source .venv/bin/activate && pip install --upgrade pip setuptools wheel",
  # Install Saleor FIRST to get its dependency versions
  "source .venv/bin/activate && pip install git+https://github.com/saleor/saleor.git",
  # Then install our additional requirements (will use compatible versions)
  "source .venv/bin/activate && pip install -r requirements.txt",
  "source .venv/bin/activate && python -c 'import saleor; print(f\"Saleor installed: {saleor.__version__}\")' || echo 'WARNING: Saleor import check failed'",
]

[phases.build]
cmds = [
  ". .venv/bin/activate && python manage.py collectstatic --noinput || true",
  # Create migrations for custom apps if they don't exist
  ". .venv/bin/activate && python manage.py makemigrations saleor_extensions.regions saleor_extensions.currency saleor_extensions.branches saleor_extensions.inventory --noinput || echo '⚠️  Migrations already exist or apps not found'",
  # Run all migrations (Saleor + custom apps)
  # Note: This requires DATABASE_URL to be set during build
  ". .venv/bin/activate && python manage.py migrate --noinput || echo '⚠️  Migration failed - will retry on first request'",
]

[start]
cmd = "bash -c 'LIB_PATH=$(find /nix/store -name libmagic.so* 2>/dev/null | head -1 | xargs dirname 2>/dev/null); export LD_LIBRARY_PATH=$LD_LIBRARY_PATH${LIB_PATH:+:$LIB_PATH} && export PYTHONPATH=$PYTHONPATH && source .venv/bin/activate && gunicorn wsgi:application --bind 0.0.0.0:$PORT --workers 4 --timeout 120'"
